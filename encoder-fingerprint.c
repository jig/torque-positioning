/****************************************************************/
/** Author: Jordi Íñigo Griera                                 **/
/** Mail: a s t r o j i g on g m a i l dot c o m               **/
/** GNU Public Licence v3                                      **/
/** Doc: see http://code.google.com/p/jig-torque-positioning   **/
/****************************************************************/

#include "encoder-fingerprint.h"

const struct encoder_point track[] = {
	{443,977},
	{446,977},
	{450,977},
	{455,977},
	{459,977},
	{463,977},
	{466,977},
	{470,977},
	{474,977},
	{478,977},
	{482,977},
	{487,977},
	{491,977},
	{495,976},
	{499,975},
	{503,975},
	{507,974},
	{511,974},
	{515,973},
	{519,972},
	{523,971},
	{527,970},
	{531,969},
	{535,968},
	{539,968},
	{543,966},
	{548,966},
	{551,965},
	{555,964},
	{559,963},
	{563,963},
	{568,962},
	{572,961},
	{576,960},
	{581,958},
	{585,957},
	{590,955},
	{593,954},
	{600,952},
	{604,950},
	{608,948},
	{613,946},
	{618,944},
	{623,942},
	{627,940},
	{630,938},
	{635,937},
	{639,935},
	{643,933},
	{647,931},
	{652,929},
	{656,927},
	{660,925},
	{664,923},
	{667,920},
	{672,918},
	{677,916},
	{681,913},
	{685,910},
	{690,908},
	{694,906},
	{698,904},
	{703,902},
	{707,899},
	{712,897},
	{716,894},
	{720,892},
	{724,889},
	{728,887},
	{733,884},
	{737,881},
	{742,878},
	{746,874},
	{751,871},
	{755,868},
	{758,865},
	{763,861},
	{767,858},
	{771,854},
	{775,851},
	{780,848},
	{783,845},
	{787,842},
	{791,839},
	{795,835},
	{799,832},
	{803,828},
	{807,825},
	{812,822},
	{816,819},
	{819,815},
	{823,812},
	{827,808},
	{831,803},
	{835,800},
	{839,797},
	{843,793},
	{847,789},
	{850,786},
	{854,782},
	{858,779},
	{862,775},
	{866,771},
	{870,767},
	{874,764},
	{878,760},
	{881,756},
	{885,752},
	{888,749},
	{892,745},
	{895,740},
	{898,736},
	{901,732},
	{905,728},
	{907,724},
	{910,721},
	{913,717},
	{916,713},
	{919,708},
	{922,704},
	{925,700},
	{928,696},
	{931,692},
	{934,689},
	{937,685},
	{939,681},
	{942,676},
	{945,672},
	{948,668},
	{950,664},
	{953,660},
	{956,657},
	{958,653},
	{961,651},
	{964,646},
	{966,643},
	{969,639},
	{970,635},
	{973,631},
	{976,627},
	{978,624},
	{980,620},
	{982,616},
	{984,612},
	{986,607},
	{988,603},
	{990,599},
	{992,595},
	{994,592},
	{996,588},
	{997,584},
	{999,580},
	{1001,576},
	{1002,572},
	{1004,568},
	{1006,565},
	{1008,561},
	{1009,557},
	{1011,553},
	{1012,549},
	{1013,545},
	{1014,542},
	{1015,538},
	{1017,534},
	{1018,531},
	{1018,528},
	{1019,524},
	{1020,520},
	{1020,517},
	{1021,513},
	{1021,510},
	{1022,506},
	{1022,502},
	{1022,499},
	{1023,495},
	{1023,492},
	{1023,488},
	{1023,485},
	{1023,481},
	{1023,478},
	{1023,474},
	{1023,471},
	{1023,467},
	{1023,464},
	{1023,460},
	{1023,457},
	{1023,454},
	{1023,450},
	{1023,447},
	{1023,443},
	{1023,440},
	{1023,437},
	{1023,434},
	{1023,431},
	{1023,427},
	{1023,424},
	{1023,421},
	{1022,418},
	{1022,415},
	{1022,411},
	{1021,408},
	{1021,405},
	{1020,402},
	{1019,399},
	{1019,396},
	{1018,393},
	{1017,390},
	{1016,387},
	{1015,384},
	{1014,381},
	{1013,379},
	{1012,376},
	{1010,373},
	{1009,370},
	{1007,367},
	{1005,364},
	{1003,361},
	{1002,358},
	{1000,355},
	{999,353},
	{998,350},
	{995,347},
	{994,344},
	{992,341},
	{990,339},
	{988,336},
	{986,333},
	{984,331},
	{982,328},
	{979,326},
	{977,323},
	{974,320},
	{972,318},
	{970,315},
	{968,312},
	{966,310},
	{963,307},
	{961,305},
	{958,302},
	{956,300},
	{953,297},
	{950,295},
	{948,292},
	{945,290},
	{942,287},
	{938,284},
	{935,282},
	{933,279},
	{930,277},
	{927,275},
	{923,272},
	{920,270},
	{917,267},
	{913,265},
	{910,263},
	{907,261},
	{905,259},
	{902,257},
	{899,254},
	{896,252},
	{892,250},
	{889,248},
	{885,246},
	{882,244},
	{879,242},
	{876,240},
	{872,238},
	{867,236},
	{863,233},
	{859,231},
	{855,229},
	{852,227},
	{848,225},
	{845,223},
	{841,221},
	{837,219},
	{833,217},
	{829,215},
	{824,213},
	{821,212},
	{817,210},
	{813,208},
	{809,206},
	{804,205},
	{799,203},
	{795,201},
	{791,200},
	{787,198},
	{784,196},
	{781,194},
	{776,193},
	{772,191},
	{772,193},
	{767,191},
	{763,190},
	{759,188},
	{755,186},
	{750,184},
	{746,183},
	{741,181},
	{736,181},
	{731,179},
	{727,178},
	{718,172},
	{714,171},
	{709,169},
	{704,168},
	{699,166},
	{695,165},
	{690,163},
	{686,162},
	{680,159},
	{676,158},
	{671,156},
	{666,155},
	{662,153},
	{656,151},
	{653,150},
	{648,149},
	{643,147},
	{639,146},
	{634,144},
	{630,143},
	{626,142},
	{621,141},
	{616,140},
	{612,138},
	{608,138},
	{602,137},
	{598,136},
	{594,135},
	{589,133},
	{584,133},
	{579,131},
	{574,130},
	{569,129},
	{565,128},
	{560,127},
	{556,126},
	{551,125},
	{547,124},
	{542,123},
	{537,122},
	{532,120},
	{529,119},
	{524,118},
	{520,117},
	{515,116},
	{511,115},
	{506,114},
	{501,113},
	{496,112},
	{492,111},
	{488,110},
	{483,109},
	{478,108},
	{474,107},
	{469,106},
	{465,106},
	{460,104},
	{456,104},
	{452,103},
	{448,102},
	{443,101},
	{438,100},
	{434,100},
	{429,99},
	{425,98},
	{421,97},
	{417,96},
	{412,96},
	{408,95},
	{404,94},
	{400,93},
	{396,93},
	{393,92},
	{389,91},
	{385,90},
	{381,90},
	{377,89},
	{373,88},
	{370,88},
	{366,87},
	{362,87},
	{358,86},
	{354,85},
	{350,85},
	{346,84},
	{342,83},
	{339,82},
	{335,82},
	{331,81},
	{327,80},
	{323,80},
	{320,79},
	{316,79},
	{313,78},
	{309,78},
	{306,77},
	{302,78},
	{298,78},
	{295,77},
	{291,77},
	{288,76},
	{285,76},
	{281,75},
	{278,75},
	{275,75},
	{271,74},
	{268,74},
	{265,74},
	{262,73},
	{259,73},
	{256,73},
	{252,72},
	{249,72},
	{246,72},
	{243,72},
	{240,71},
	{237,71},
	{235,71},
	{232,71},
	{229,71},
	{226,71},
	{223,71},
	{220,70},
	{217,70},
	{215,70},
	{211,69},
	{208,69},
	{205,69},
	{202,68},
	{200,68},
	{197,68},
	{195,68},
	{192,68},
	{189,67},
	{187,67},
	{184,67},
	{183,68},
	{181,68},
	{178,68},
	{176,68},
	{174,68},
	{170,67},
	{168,67},
	{165,67},
	{164,67},
	{161,67},
	{159,68},
	{157,68},
	{155,68},
	{153,68},
	{151,68},
	{149,68},
	{149,69},
	{147,70},
	{145,70},
	{143,70},
	{141,70},
	{139,69},
	{137,69},
	{135,70},
	{133,70},
	{132,70},
	{130,70},
	{128,71},
	{127,71},
	{124,70},
	{122,71},
	{121,71},
	{120,72},
	{119,72},
	{117,73},
	{116,73},
	{115,73},
	{112,74},
	{111,74},
	{109,75},
	{109,76},
	{108,77},
	{107,77},
	{106,78},
	{105,79},
	{102,80},
	{101,80},
	{100,81},
	{100,81},
	{99,82},
	{97,83},
	{96,83},
	{96,84},
	{93,85},
	{92,85},
	{91,86},
	{92,87},
	{91,87},
	{90,88},
	{89,89},
	{88,90},
	{86,91},
	{85,91},
	{84,92},
	{84,93},
	{83,94},
	{83,95},
	{82,96},
	{81,97},
	{79,98},
	{79,99},
	{78,100},
	{78,101},
	{77,102},
	{77,103},
	{76,104},
	{75,105},
	{75,107},
	{74,108},
	{74,109},
	{74,110},
	{74,111},
	{73,112},
	{73,114},
	{72,115},
	{72,116},
	{71,118},
	{71,119},
	{71,121},
	{70,122},
	{70,124},
	{70,125},
	{69,127},
	{69,128},
	{69,130},
	{68,132},
	{68,133},
	{68,135},
	{67,136},
	{67,138},
	{67,140},
	{67,142},
	{66,144},
	{66,145},
	{66,147},
	{66,149},
	{66,151},
	{65,153},
	{65,155},
	{65,157},
	{65,159},
	{65,161},
	{65,162},
	{64,164},
	{64,166},
	{64,168},
	{64,171},
	{64,173},
	{64,175},
	{64,177},
	{64,180},
	{64,182},
	{64,184},
	{64,187},
	{64,189},
	{64,192},
	{64,194},
	{64,196},
	{64,199},
	{64,201},
	{64,204},
	{64,206},
	{64,208},
	{64,211},
	{64,214},
	{64,216},
	{65,219},
	{65,221},
	{65,224},
	{65,227},
	{65,229},
	{65,232},
	{65,235},
	{66,238},
	{66,241},
	{66,244},
	{66,247},
	{67,250},
	{67,253},
	{67,256},
	{67,259},
	{68,262},
	{68,265},
	{68,268},
	{68,271},
	{69,274},
	{69,277},
	{69,280},
	{69,284},
	{70,287},
	{70,290},
	{71,293},
	{71,296},
	{71,300},
	{72,303},
	{72,306},
	{72,310},
	{73,313},
	{73,316},
	{74,320},
	{74,323},
	{75,327},
	{75,330},
	{75,334},
	{76,337},
	{76,341},
	{77,345},
	{77,348},
	{78,352},
	{78,356},
	{79,360},
	{79,364},
	{80,368},
	{80,371},
	{81,375},
	{81,379},
	{82,383},
	{82,387},
	{83,390},
	{84,394},
	{84,398},
	{85,402},
	{86,406},
	{86,411},
	{87,415},
	{88,419},
	{88,423},
	{89,427},
	{90,431},
	{90,436},
	{91,440},
	{92,444},
	{92,448},
	{93,452},
	{94,456},
	{94,460},
	{95,465},
	{96,469},
	{96,473},
	{97,478},
	{98,482},
	{99,487},
	{100,491},
	{100,496},
	{101,501},
	{102,505},
	{103,510},
	{104,514},
	{105,519},
	{105,524},
	{106,528},
	{107,533},
	{108,537},
	{109,542},
	{110,547},
	{111,552},
	{112,557},
	{113,561},
	{114,566},
	{115,570},
	{116,575},
	{117,580},
	{118,585},
	{119,590},
	{120,594},
	{121,599},
	{122,604},
	{123,609},
	{124,614},
	{125,619},
	{126,624},
	{128,628},
	{129,632},
	{130,637},
	{131,642},
	{132,647},
	{133,652},
	{135,656},
	{136,660},
	{137,664},
	{138,669},
	{140,674},
	{141,679},
	{142,684},
	{144,689},
	{145,693},
	{146,697},
	{147,702},
	{149,707},
	{150,712},
	{152,716},
	{153,721},
	{155,725},
	{156,730},
	{158,734},
	{159,739},
	{161,744},
	{163,749},
	{164,753},
	{166,757},
	{168,762},
	{169,766},
	{171,770},
	{173,773},
	{174,778},
	{176,782},
	{178,785},
	{180,789},
	{182,792},
	{184,796},
	{185,800},
	{187,804},
	{189,808},
	{191,812},
	{193,816},
	{195,820},
	{197,824},
	{199,828},
	{201,832},
	{203,837},
	{205,841},
	{208,845},
	{210,848},
	{212,851},
	{214,855},
	{217,859},
	{219,863},
	{221,866},
	{223,870},
	{226,874},
	{228,877},
	{231,880},
	{233,883},
	{236,886},
	{238,889},
	{241,892},
	{243,894},
	{246,897},
	{248,900},
	{251,903},
	{256,905},
	{258,908},
	{261,910},
	{263,913},
	{266,916},
	{269,918},
	{272,921},
	{274,923},
	{278,925},
	{280,927},
	{283,930},
	{284,931},
	{287,933},
	{290,936},
	{293,937},
	{296,939},
	{299,941},
	{302,943},
	{305,946},
	{308,948},
	{311,950},
	{314,952},
	{318,954},
	{321,955},
	{324,956},
	{327,958},
	{330,959},
	{334,961},
	{337,962},
	{341,963},
	{344,964},
	{348,964},
	{351,966},
	{355,967},
	{358,968},
	{362,969},
	{366,971},
	{369,972},
	{373,973},
	{376,973},
	{380,974},
	{383,975},
	{387,976},
	{391,976},
	{394,977},
	{398,977},
	{402,978},
	{405,978},
	{409,978},
	{413,979},
	{417,979},
	{421,979},
	{425,979},
	{428,979},
	{432,979},
	{436,979},
	{440,979}
};

#define COARSEINC 100
#define INC1 50
#define INC2 7
#define _TRACK_LENGTH (sizeof track/sizeof (struct encoder_point))
#define _LAST_COARSE1_TRACK_POSITION ((_TRACK_LENGTH/INC1)*INC1)
#define _LAST_COARSE2_TRACK_POSITION ((_TRACK_LENGTH/INC2)*INC2)

#define _LAP_SCAN_THRESHOLD_LOW 250
#define _LAP_SCAN_THRESHOLD_HIGH 560

const unsigned int coarseInc = COARSEINC;
const unsigned int inc1 = INC1;
const unsigned int inc2 = INC2;
const unsigned int TRACK_LENGTH = _TRACK_LENGTH;
const unsigned int LAST_COARSE1_TRACK_POSITION = _LAST_COARSE1_TRACK_POSITION;
const unsigned int LAST_COARSE2_TRACK_POSITION = _LAST_COARSE2_TRACK_POSITION;
const unsigned int LAP_SCAN_THRESHOLD_LOW = _LAP_SCAN_THRESHOLD_LOW;
const unsigned int LAP_SCAN_THRESHOLD_HIGH = _LAP_SCAN_THRESHOLD_HIGH;
